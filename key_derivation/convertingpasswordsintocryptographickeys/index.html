<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.26" />
    <meta name="description" content="">


    <title>Converting a (master) password into a cryptographic key :: Bouncy GPG</title>
    <link rel="shortcut icon" href="https://github.com/neuhalje/bouncy-gpg/images/favicon.png" type="image/x-icon" />
    <link href="https://github.com/neuhalje/bouncy-gpg/css/nucleus.css" rel="stylesheet">
    <link href="https://github.com/neuhalje/bouncy-gpg/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://github.com/neuhalje/bouncy-gpg/css/hybrid.css" rel="stylesheet">
    <link href="https://github.com/neuhalje/bouncy-gpg/css/featherlight.min.css" rel="stylesheet">
    <link href="https://github.com/neuhalje/bouncy-gpg/css/horsey.css" rel="stylesheet">
    
    <link href="https://github.com/neuhalje/bouncy-gpg/css/theme.css" rel="stylesheet">
    
    
    <link rel="stylesheet" href="https://github.com/neuhalje/bouncy-gpg/css/bootstrap.min.css">
    <script src="https://github.com/neuhalje/bouncy-gpg/js/jquery-2.x.min.js"></script>
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left {
        display:none !important;
      }
    </style>

    

    

  </head>
  <body class="" data-url="/key_derivation/convertingpasswordsintocryptographickeys/">
    <nav id="sidebar" class="">





<div class="highlightable">
  <div id="header-wrapper">
    <div id="header">
      
<span style="font-size:smaller">
	<a id="logo" href="https://github.com/neuhalje/bouncy-gpg">
	  <span class="fa fa-gears" style="font-size:large"></span>
	</a>
	Create a _header.md to customize this
</small>


    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>
<script type="text/javascript" src="https://github.com/neuhalje/bouncy-gpg/js/lunr.min.js"></script>
<script type="text/javascript" src="https://github.com/neuhalje/bouncy-gpg/js/horsey.js"></script>
<script type="text/javascript">
    var baseurl = "https:\/\/github.com\/neuhalje\/bouncy-gpg";
</script>
<script type="text/javascript" src="https://github.com/neuhalje/bouncy-gpg/js/search.js"></script>

    
  </div>

  
    <ul class="topics">
        
            <li data-nav-id="/" class="dd-item">
            <a href="https://github.com/neuhalje/bouncy-gpg/"><i class="fa fa-fw fa-home"></i></a>
            </li>
        
        
        
          
          


 
  
    
    <li data-nav-id="/key_derivation/" class="dd-item 
        parent
        
        
        ">
      <a href="https://github.com/neuhalje/bouncy-gpg/key_derivation/">
        <span>Key_derivations</span>

        
        

          
            <i class="fa fa-angle-down fa-lg category-icon"></i>
          

        

        
      </a>
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/key_derivation/convertingpasswordsintocryptographickeys/" class="dd-item
     active
      ">
        <a href="https://github.com/neuhalje/bouncy-gpg/key_derivation/convertingpasswordsintocryptographickeys/">
        <span>Converting a (master) password into a cryptographic key</span> 
        
        </a></li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
        

        
    </ul>
    
     
    <section id="footer">
      
    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
        
          <div id="top-bar">
            

            <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                <span id="sidebar-toggle-span">
                  <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                    <i class="fa fa-bars"></i>
                  </a>
                </span>
                <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                <span class="links">
                







 <a href='https://github.com/neuhalje/bouncy-gpg/'>Bouncy GPG</a> > <a href='https://github.com/neuhalje/bouncy-gpg/key_derivation/'>Key_derivations</a> > Converting a (master) password into a cryptographic key

 

 

   
                </span>
            </div>
            <div class="progress">
    <div class="wrapper">

    </div>
</div>

          </div>
        
        
          <div id="tags">
            
              <a class="label label-default" href="https://github.com/neuhalje/bouncy-gpg/tags/specification">specification</a>
            
              <a class="label label-default" href="https://github.com/neuhalje/bouncy-gpg/tags/development">development</a>
            
          </div>
        
        <div id="body-inner">
          
            <h1>Converting a (master) password into a cryptographic key</h1>
          




<p>Most systems use passwords to create (derive) cryptographic keys, e.g. the password to decrypt a ZIP file is used to create a cryptographic key.</p><p>The process of creating a cryptographic key from a password is called <em>password based key derivation</em>. Because passwords are often to short/predictable this derivation often also implements some kind of <em>key strengthening</em> or <em>key stretching</em> (see below for more info).</p><p>To properly derive a key from a passwords a few aspects are important to consider. </p><h2>TL;RD: Recommendation</h2><ul><li>Use long and complex passwords as key source (128 bit key =&gt; 22 characters, 256 bit keys =&gt; 44 characters!)</li><li>Use a random salt value that is as long as the key (128 or 256 bits)</li><li>Configure the key stretching to be as slow (sic!) as possible</li></ul><h3>Usage with Bouncy-GPG</h3><p>Cryptographic key derivation functions should be used to derive a key from a password (or <em>any</em> other source material). Bouncy-GPG uses <a href="https://en.wikipedia.org/wiki/Scrypt">SCrypt</a> for key stretching.</p><p>The following snippet will derive a 256 bit key from a strong password. The derivation process is configured by <code>SCryptKeyStretchingParameters.forStrongInputKeyMaterial()</code>. This will give a very quick key derivation and is only secure because the password is very long and random. If a shorter password was used the recommendation would be to use:</p><pre><code script:lang="groovy" xmlns:script="urn:concordion-extensions:2010" script:result="#generatedKey" id="groovy">import java.nio.charset.StandardCharsets;

import org.bouncycastle.util.encoders.Hex;

import name.neuhalfen.projects.crypto.symmetric.keygeneration.impl.stretching.KeyStretching;
import name.neuhalfen.projects.crypto.symmetric.keygeneration.impl.stretching.SCryptKeyStretching;

// the password
String password = "39akldsAFQqwmsx-+#aQcsvcu82cQd,.-ask72=cq8csf";

// The salt value should be application or installation specific.
// It is an absolute MUST that the salt is never changed! A different salt WILL result in a different
// key being generated!
// The salt value SHOULD be roughly as long as the key (e.g. 128/256 bit).
// The salt value SHOULD be random (so this salt value is actually a bad example)
final byte[] SALT = Hex.decode("000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f");

// In this case we are using a 256 bit key, e.g. for AES-128.
final int DESIRED_KEY_LENGTH = 256;

// Use forSensitiveStorage to derive e.g. a masterkey at application startup.
// forSensitiveStorage is really slow. If you are very sure that you have a very
// good (22 characters random or longer) password for 128 bit keys / 44 character 
// passwords for 256 bit keys you can consider using forQuickDerivation.
final SCryptKeyStretching.SCryptKeyStretchingParameters stretchingParameters = SCryptKeyStretching.SCryptKeyStretchingParameters.forStrongInputKeyMaterial();
final KeyStretching streching = new SCryptKeyStretching(stretchingParameters);

byte[] key = streching.strengthenKey(SALT, password.getBytes(StandardCharsets.UTF_8), DESIRED_KEY_LENGTH);
return key;<p/></code></pre><p>The key generated by this sequence is <span concordion:assert-equals="toHex(#generatedKey)" xmlns:concordion="http://www.concordion.org/2007/concordion" class="success">0x89d4a9b23d8a88d09e559aeeaa7cfa4a029673b01d969a2f523a7c1f749c330b</span>.</p><h1>Requirements for key derivation</h1><p>For those interested in learning a bit of background about key derivation the following paragraphs give a very short overview of the basic requirements of key derivation (from a password).</p><p>These are not all requirements for key derivation functions. The requirements shown here shed some light on key derivation functions from an <em>API user</em> perspective.</p><h3>Deterministic</h3><p>The process of key derivation has to be <a href="https://en.wikipedia.org/wiki/Deterministic_system">deterministic</a>. That is, given the same input parameters (password and other parameters of the <em>derivation function</em>) the generated key is always the same.</p><div concordion:example="Key derivation is deterministic" xmlns:concordion="http://www.concordion.org/2007/concordion" id="Key derivation is deterministic"><h4>Example</h4><p>E.g. the password <em><span concordion:set="#password">s3cret</span></em> (which is <em>way</em> to short!) might be <span concordion:execute="#key = stretchWithFixedParameters(#password)">derived</span> to the key <span concordion:assert-equals="#key.derivedKey" class="success">0x81d0994d0aa21b786d6b8dc45fc09f31</span>.</p><p><span concordion:execute="#key2 = stretchWithFixedParameters(#password)">Calling</span> the derivation function with the same parameters again yields the same result (<span concordion:assert-equals="#key2.derivedKey" class="success">0x81d0994d0aa21b786d6b8dc45fc09f31</span>).</p><p>Using the same password with different configuration parameters for the same password (e.g. with a different <a href="https://en.wikipedia.org/wiki/Salt_%28cryptography%29">salt</a> value) <span concordion:assert-true="isSaltChangesKey(#password)" class="success">yields a different key</span>.</p></div><h3>Password length</h3><p>Cryptographically strong passwords are remarkably difficult to use because they are really, really long. For the sake of discussion assume a password with the allowed symbols <code>a-z + A-Z + 0-9</code>. That are 62 different symbols per character. This is a bit less than ~6 bit per character.</p><p>A cryptographic key typically has a length of 128 or 256 completely random bits. E.g. a secure 128 bit key would require a completely random password of 22 characters (precisely <code>128 / log_2(62)</code> [*]). Sometimes this cannot be ensured, for example when the password is a users login password.</p><p>To derive keys from passwords two length-related problems need to be solved:</p><ol><li>Squash arbitrary long passwords into 128 / 256 bit keys</li><li>Prevent attackers from enumerating (to short) passwords</li></ol><p>[*] <em>Rule of thumb: <code>c</code> possible symbols are <code>log_2(c)</code> bits per character. <code>n</code> characters are then <code>n * log_2(c)</code> bits. If your calculator does not have <code>log_2</code> use <code>num_bits ~= n * 3.3 * log_10(c)</code></em></p><div concordion:example="Key length is independent from password length" xmlns:concordion="http://www.concordion.org/2007/concordion" id="Key length is independent from password length"><h4>Example: Key length is independent from password length</h4><p>The length of the derived key is independent from the length of the password [1]:</p><table concordion:execute="#key = stretchWithFixedParameters(#password, #desiredKeyLen)"><thead><tr><th concordion:set="#password">Password </th><th concordion:set="#desiredKeyLen">Desired key length in bit </th><th concordion:assert-equals="#key.derivedKey">derived key </th><th concordion:assert-equals="#key.derivedKeyLen">length of derived key </th></tr></thead><tbody><tr><td>x </td><td>128 </td><td class="success">0xec8bf237a7207690e91cf6bd27746f3b </td><td class="success">128 </td></tr><tr><td>short password </td><td>128 </td><td class="success">0x185e58c7cf69baef9d2866b70ec1581c </td><td class="success">128 </td></tr><tr><td>short password </td><td>256 </td><td class="success">0x185e58c7cf69baef9d2866b70ec1581ceb8ff7c5c2169170cba1cf4adc48815a </td><td class="success">256 </td></tr><tr><td>a bit longer PASSWORD </td><td>128 </td><td class="success">0xb201445d3bcdc7a07c469b7d7ef8988c </td><td class="success">128 </td></tr></tbody></table><p>[1] Salt and all other derivation parameters fixed for this run. Changing the salt or the parameters of the derivation function does not change the key length.</p></div><div concordion:example="Prevent pre-computation with salt" xmlns:concordion="http://www.concordion.org/2007/concordion" id="Prevent pre-computation with salt"><h4>Example: Prevent pre-computation with salt</h4><p>Especially for short passwords it is desirable to prevent attackers from pre-computing (e.g. with <a href="https://en.wikipedia.org/wiki/Rainbow_table">Rainbow tables</a>) all possible keys upfront.</p><p>There are two strategies to achieve this.</p><p>First the calculation can include an additional parameter that makes key derivation specific to an application/installation. This raises the bar for the attacker because the pre-computation for one application cannot be used for a second application. Such a value is called a <a href="https://en.wikipedia.org/wiki/Salt_%28cryptography%29">salt</a> and can be public.</p><p>Secondly, computation can be made very expensive, so that an attacker would need to spend to much time to compute all possible keys. This approach is implemented by functions such as <a href="https://en.wikipedia.org/wiki/Scrypt">SCrypt</a> or <a href="https://tools.ietf.org/html/rfc2898">PBKDF2</a>. Slowing down computations is especially important for cases where the attacker has access to the database with the password hashes (and the salt). This is not unlikely because databases are stolen quite frequently. Brute force protection makes key generation much slower, thus hampering an attacker to just try out every possible user password to "brute force" the key.</p><p>Changing the salt value will derive different keys from the same password (thus making precomputing infeasible):</p><table concordion:execute="#key = stretchWithSalt(#password, #salt)"><thead><tr><th concordion:set="#password">Password </th><th concordion:set="#salt">Salt </th><th concordion:assert-equals="#key.derivedKey">derived key </th></tr></thead><tbody><tr><td>a bit longer PASSWORD </td><td>0x00 </td><td class="success">0x62109f2b71882325eb62fb2d4dae3ef2 </td></tr><tr><td>short password </td><td>0x00 </td><td class="success">0xa8182f30638baea8c1b6991dd8f71070 </td></tr><tr><td>short password </td><td>0x01 </td><td class="success">0x185e58c7cf69baef9d2866b70ec1581c </td></tr><tr><td>short password </td><td>0x0123456789abcdef0123456789abcdef </td><td class="success">0x89b4d1be23e0f1f56ba29ee36f1e52ba </td></tr></tbody></table></div><h3>Unwanted structure / lacking entropy</h3><p>Besides the length of the password, it also has a lot of inherent structure (e.g. the mentioned 62 symbols all have the most significant bit set to zero). This structure needs to be "smoothed out" before using the password das key material.</p><h3>Further Reading</h3><ul><li><a href="https://en.wikipedia.org/wiki/Key_stretching">Key stretching</a> on Wikipedia.</li><li><a href="http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-132.pdf">NIST Special Publication 800-132: Recommendation for Password-Based Key Derivation</a></li><li><a href="https://en.wikipedia.org/wiki/Key_derivation_function">Key derivation function</a> on Wikipedia.</li></ul><div class="footer">Results generated by <a href="http://www.concordion.org" style="font-weight: bold; text-decoration: none; color: #89C;">Concordion</a><div class="testTime">in 1071 ms on 19-Aug-2017 at 00:06:26 CEST</div></div>

<footer class=" footline" >
	
</footer>



      </div>
    </div>

    
 
    

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="https://github.com/neuhalje/bouncy-gpg/key_derivation/" title="Key_derivations"> <i class="fa fa-chevron-left"></i></a>
        
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://github.com/neuhalje/bouncy-gpg/js/clipboard.min.js"></script>
    <script src="https://github.com/neuhalje/bouncy-gpg/js/featherlight.min.js"></script>
    <script src="https://github.com/neuhalje/bouncy-gpg/js/html5shiv-printshiv.min.js"></script>
    <script src="https://github.com/neuhalje/bouncy-gpg/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://github.com/neuhalje/bouncy-gpg/js/modernizr.custom.71422.js"></script>
    <script src="https://github.com/neuhalje/bouncy-gpg/js/learn.js"></script>
    <script src="https://github.com/neuhalje/bouncy-gpg/js/hugo-learn.js"></script>

    
    <link href="https://github.com/neuhalje/bouncy-gpg/mermaid/mermaid.css" type="text/css" rel="stylesheet"/>
    <script src="https://github.com/neuhalje/bouncy-gpg/mermaid/mermaid.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    

    

  </body>
</html>

